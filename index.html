<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas Expresivas - Material 3</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter (base) y para el editor -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Roboto:wght@400;700&family=Lato:wght@400;700&family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* Estilos base y configuración de Material 3 Expressive */
        :root {
            --md-sys-color-primary-light: #825500;
            --md-sys-color-on-primary-light: #ffffff;
            --md-sys-color-primary-container-light: #ffddb3;
            --md-sys-color-surface-light: #fffbff;
            --md-sys-color-surface-variant-light: #f2e0d0;
            --md-sys-color-on-surface-light: #1f1b16;
            --md-sys-color-on-surface-variant-light: #4f4539;
            --md-sys-color-outline-light: #837568;

            --md-sys-color-primary-dark: #ffb951;
            --md-sys-color-on-primary-dark: #452b00;
            --md-sys-color-primary-container-dark: #633f00;
            --md-sys-color-surface-dark: #1f1b16;
            --md-sys-color-surface-variant-dark: #4f4539;
            --md-sys-color-on-surface-dark: #eadecf;
            --md-sys-color-on-surface-variant-dark: #d5c4b4;
            --md-sys-color-outline-dark: #9d8e81;
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        /* Animaciones para modales y notas */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .fade-out { animation: fadeOut 0.3s ease-in forwards; }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .scale-out { animation: scaleOut 0.3s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes scaleOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        /* Estilo para items de to-do list tachados */
        .task-done { text-decoration: line-through; opacity: 0.7; }
        
        /* Animación para el botón de tema */
        #sun-icon { opacity: 0; transform: rotate(90deg) scale(0.5); }
        .dark #sun-icon { opacity: 1; transform: rotate(0) scale(1); }
        #moon-icon { opacity: 1; transform: rotate(0) scale(1); }
        .dark #moon-icon { opacity: 0; transform: rotate(-90deg) scale(0.5); }
        
        .note-card-body { cursor: pointer; }

        /* Estilos para el editor WYSIWYG */
        #note-content-wysiwyg {
            min-height: 150px;
            outline: none;
        }
        #note-content-wysiwyg:empty:before {
            content: "Empieza a escribir tu documento...";
            color: var(--md-sys-color-on-surface-variant-light);
            cursor: text;
        }
        .dark #note-content-wysiwyg:empty:before {
            color: var(--md-sys-color-on-surface-variant-dark);
        }
        .toolbar-btn {
            border: none;
            background: transparent;
            padding: 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .toolbar-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }
        .dark .toolbar-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .toolbar-select {
            background: transparent;
            border: 1px solid var(--md-sys-color-outline-light);
            border-radius: 8px;
            padding: 0.25rem 0.5rem;
        }
        .dark .toolbar-select {
            border-color: var(--md-sys-color-outline-dark);
        }

        /* --- NUEVOS ESTILOS PARA LA VISTA DE LISTA --- */
        #notes-container.view-list {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Espacio entre notas en la vista de lista */
        }

        #notes-container.view-list .note-card {
             max-width: 800px; /* Ancho máximo para la legibilidad */
             margin: 0 auto; /* Centrar las tarjetas en la vista de lista */
             width: 100%;
        }
        
        /* Spinner para carga de IA */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--md-sys-color-primary-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .dark .spinner {
             border-left-color: var(--md-sys-color-primary-dark);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-light': 'var(--md-sys-color-primary-light)', 'on-primary-light': 'var(--md-sys-color-on-primary-light)', 'primary-container-light': 'var(--md-sys-color-primary-container-light)', 'surface-light': 'var(--md-sys-color-surface-light)', 'surface-variant-light': 'var(--md-sys-color-surface-variant-light)', 'on-surface-light': 'var(--md-sys-color-on-surface-light)', 'on-surface-variant-light': 'var(--md-sys-color-on-surface-variant-light)', 'outline-light': 'var(--md-sys-color-outline-light)',
                        'primary-dark': 'var(--md-sys-color-primary-dark)', 'on-primary-dark': 'var(--md-sys-color-on-primary-dark)', 'primary-container-dark': 'var(--md-sys-color-primary-container-dark)', 'surface-dark': 'var(--md-sys-color-surface-dark)', 'surface-variant-dark': 'var(--md-sys-color-surface-variant-dark)', 'on-surface-dark': 'var(--md-sys-color-on-surface-dark)', 'on-surface-variant-dark': 'var(--md-sys-color-on-surface-variant-dark)', 'outline-dark': 'var(--md-sys-color-outline-dark)',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-surface-light dark:bg-surface-dark text-on-surface-light dark:text-on-surface-dark transition-colors duration-500">

    <!-- Encabezado -->
    <header class="sticky top-0 z-10 bg-surface-light/80 dark:bg-surface-dark/80 backdrop-blur-sm transition-colors duration-500">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-primary-light dark:text-primary-dark">Notas Expresivas</h1>
            <div class="flex items-center gap-2">
                <!-- NUEVO: Botón para cambiar vista -->
                <button id="view-toggle" class="p-2 rounded-full hover:bg-surface-variant-light dark:hover:bg-surface-variant-dark transition-colors duration-300">
                    <span class="material-symbols-outlined">grid_view</span>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-surface-variant-light dark:hover:bg-surface-variant-dark transition-colors duration-300">
                    <div class="relative w-6 h-6">
                        <span id="sun-icon" class="material-symbols-outlined absolute inset-0 transition-all duration-500">light_mode</span>
                        <span id="moon-icon" class="material-symbols-outlined absolute inset-0 transition-all duration-500">dark_mode</span>
                    </div>
                </button>
            </div>
        </div>
    </header>

    <!-- Contenedor de Notas -->
    <main class="container mx-auto p-4">
        <div id="notes-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        <div id="placeholder" class="text-center py-20 text-on-surface-variant-light dark:text-on-surface-variant-dark">
            <span class="material-symbols-outlined text-6xl">description</span>
            <p class="mt-4 text-lg">Aún no hay notas. ¡Crea una!</p>
        </div>
    </main>

    <!-- Contenedor del Botón Flotante (FAB) -->
    <div class="fixed bottom-8 right-8 z-20 flex flex-col items-center gap-4">
        <div id="fab-menu" class="flex flex-col items-end gap-3 transition-all duration-200 ease-in-out transform translate-y-4 opacity-0 pointer-events-none">
            <div class="flex items-center gap-3"><span class="bg-surface-light dark:bg-surface-dark shadow-md p-2 rounded-lg text-sm">Documento</span><button data-type="doc" class="fab-option bg-surface-variant-light dark:bg-surface-variant-dark text-on-surface-variant-light dark:text-on-surface-variant-dark w-12 h-12 rounded-xl shadow-lg flex items-center justify-center transform hover:scale-105 transition-transform"><span class="material-symbols-outlined">article</span></button></div>
            <div class="flex items-center gap-3"><span class="bg-surface-light dark:bg-surface-dark shadow-md p-2 rounded-lg text-sm">To-do List</span><button data-type="todolist" class="fab-option bg-surface-variant-light dark:bg-surface-variant-dark text-on-surface-variant-light dark:text-on-surface-variant-dark w-12 h-12 rounded-xl shadow-lg flex items-center justify-center transform hover:scale-105 transition-transform"><span class="material-symbols-outlined">checklist</span></button></div>
            <div class="flex items-center gap-3"><span class="bg-surface-light dark:bg-surface-dark shadow-md p-2 rounded-lg text-sm">Nota</span><button data-type="note" class="fab-option bg-surface-variant-light dark:bg-surface-variant-dark text-on-surface-variant-light dark:text-on-surface-variant-dark w-12 h-12 rounded-xl shadow-lg flex items-center justify-center transform hover:scale-105 transition-transform"><span class="material-symbols-outlined">edit_note</span></button></div>
        </div>
        <button id="add-note-fab" class="bg-primary-container-light dark:bg-primary-container-dark text-on-primary-container-light dark:text-on-primary-container-dark w-16 h-16 rounded-2xl shadow-lg flex items-center justify-center transform hover:scale-105 transition-transform">
            <span id="fab-icon" class="material-symbols-outlined text-3xl transition-transform duration-200">add</span>
        </button>
    </div>

    <!-- Modal para Añadir/Editar Nota -->
    <div id="note-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div id="note-modal-content" class="bg-surface-light dark:bg-surface-dark rounded-3xl shadow-2xl w-full max-w-2xl p-6 transform flex flex-col h-[90vh] relative">
            <!-- NUEVO: Overlay de carga para IA -->
            <div id="ai-loading-overlay" class="absolute inset-0 bg-surface-light/80 dark:bg-surface-dark/80 z-10 flex-col gap-4 flex items-center justify-center hidden">
                <div class="spinner"></div>
                <p class="text-on-surface-variant-light dark:text-on-surface-variant-dark">Generando texto con IA...</p>
            </div>
            <form id="note-form" class="flex flex-col flex-grow h-full">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <button type="button" id="cancel-button" class="p-2 rounded-full hover:bg-surface-variant-light dark:hover:bg-surface-variant-dark transition-colors"><span class="material-symbols-outlined">close</span></button>
                    <div class="flex items-center gap-2">
                        <!-- NUEVO: Botón de escritura con IA -->
                        <button type="button" id="ai-write-btn" class="hidden px-4 py-2 rounded-full bg-primary-light/10 dark:bg-primary-dark/10 text-primary-light dark:text-primary-dark hover:bg-primary-light/20 dark:hover:bg-primary-dark/20 flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">auto_awesome</span>
                            <span class="text-sm font-medium">Escribir con IA</span>
                        </button>
                        <button type="button" id="add-image-btn" class="p-2 rounded-full hover:bg-surface-variant-light dark:hover:bg-surface-variant-dark transition-colors"><span class="material-symbols-outlined">add_photo_alternate</span></button>
                        <button type="submit" id="save-button" class="px-6 py-2 rounded-full bg-primary-light dark:bg-primary-dark text-on-primary-light dark:text-on-primary-dark hover:opacity-90 transition-opacity">Guardar</button>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto pr-2">
                    <input type="hidden" id="note-id"><input type="hidden" id="note-type"><input type="hidden" id="note-image-data">
                    <div id="image-preview-container" class="hidden relative w-full h-48 rounded-lg overflow-hidden my-2">
                        <img id="image-preview" src="" class="w-full h-full object-cover">
                        <button type="button" id="remove-image-btn" class="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1"><span class="material-symbols-outlined text-lg">close</span></button>
                    </div>
                    <input type="text" id="note-title" placeholder="Título" class="w-full bg-transparent text-3xl font-bold outline-none py-2 mb-2">
                    
                    <div id="doc-toolbar" class="hidden flex-wrap items-center gap-2 border-y border-outline-light/50 dark:border-outline-dark/50 my-2 py-2">
                        <select id="font-name-select" class="toolbar-select text-sm"><option value="Inter">Inter</option><option value="Roboto">Roboto</option><option value="Lato">Lato</option><option value="Merriweather">Merriweather</option><option value="Playfair Display">Playfair Display</option></select>
                        <select id="font-size-select" class="toolbar-select text-sm"><option value="3">Normal</option><option value="5">Grande</option><option value="7">Título</option></select>
                        <button type="button" class="toolbar-btn" data-command="bold"><span class="material-symbols-outlined">format_bold</span></button>
                        <button type="button" class="toolbar-btn" data-command="italic"><span class="material-symbols-outlined">format_italic</span></button>
                        <button type="button" class="toolbar-btn" data-command="underline"><span class="material-symbols-outlined">format_underlined</span></button>
                    </div>

                    <div id="content-editor" class="mt-4 flex-grow flex flex-col">
                        <textarea id="note-content-textarea" class="w-full bg-transparent flex-grow outline-none resize-none text-lg leading-relaxed" placeholder="Empieza a escribir..."></textarea>
                        <div id="note-content-wysiwyg" contenteditable="true" class="w-full h-full bg-transparent flex-grow text-lg leading-relaxed hidden"></div>
                        <div id="todolist-editor" class="hidden flex-grow flex flex-col gap-2"></div>
                    </div>
                </div>
                <input type="file" id="image-input" class="hidden" accept="image/*">
            </form>
        </div>
    </div>
    
    <!-- Modal de Vista a Pantalla Completa -->
    <div id="note-view-modal" class="fixed inset-0 bg-surface-light dark:bg-surface-dark z-40 p-4 sm:p-8 hidden">
        <div class="w-full h-full max-w-4xl mx-auto flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 id="note-view-title" class="text-3xl sm:text-4xl font-bold text-primary-light dark:text-primary-dark break-words"></h2>
                <div class="flex gap-2">
                    <button id="note-view-edit-btn" class="p-2 rounded-full hover:bg-surface-variant-light dark:hover:bg-surface-variant-dark"><span class="material-symbols-outlined">edit</span></button>
                    <button id="note-view-close-btn" class="p-2 rounded-full hover:bg-surface-variant-light dark:hover:bg-surface-variant-dark"><span class="material-symbols-outlined">close</span></button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto pr-2">
                <img id="note-view-image" src="" class="w-full max-h-96 rounded-2xl object-cover mb-6 hidden">
                <div id="note-view-body" class="text-lg leading-relaxed prose dark:prose-invert max-w-none"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Borrado -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div id="delete-modal-content" class="bg-surface-light dark:bg-surface-dark rounded-3xl shadow-2xl w-full max-w-sm p-6 transform">
            <h2 class="text-xl font-bold mb-2">Confirmar borrado</h2>
            <p class="text-on-surface-variant-light dark:text-on-surface-variant-dark mb-6">¿Estás seguro de que quieres eliminar esta nota? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-delete-button" class="px-6 py-2 rounded-full text-primary-light dark:text-primary-dark hover:bg-primary-light/10">Cancelar</button>
                <button type="button" id="confirm-delete-button" class="px-6 py-2 rounded-full bg-red-600 text-white hover:opacity-90">Eliminar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos del DOM ---
            const themeToggle = document.getElementById('theme-toggle');
            const viewToggle = document.getElementById('view-toggle'); // NUEVO
            const notesContainer = document.getElementById('notes-container');
            const placeholder = document.getElementById('placeholder');
            const addNoteFab = document.getElementById('add-note-fab');
            const fabIcon = document.getElementById('fab-icon');
            const fabMenu = document.getElementById('fab-menu');
            // Modal de edición
            const noteModal = document.getElementById('note-modal');
            const noteModalContent = document.getElementById('note-modal-content');
            const noteForm = document.getElementById('note-form');
            const noteIdInput = document.getElementById('note-id');
            const noteTypeInput = document.getElementById('note-type');
            const noteImageDataInput = document.getElementById('note-image-data');
            const noteTitleInput = document.getElementById('note-title');
            const cancelButton = document.getElementById('cancel-button');
            const imageInput = document.getElementById('image-input');
            const addImageBtn = document.getElementById('add-image-btn');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const removeImageBtn = document.getElementById('remove-image-btn');
            // Editores de contenido
            const noteContentTextarea = document.getElementById('note-content-textarea');
            const noteContentWysiwyg = document.getElementById('note-content-wysiwyg');
            const todolistEditor = document.getElementById('todolist-editor');
            const docToolbar = document.getElementById('doc-toolbar');
            // Modal de vista
            const noteViewModal = document.getElementById('note-view-modal');
            const noteViewTitle = document.getElementById('note-view-title');
            const noteViewImage = document.getElementById('note-view-image');
            const noteViewBody = document.getElementById('note-view-body');
            const noteViewEditBtn = document.getElementById('note-view-edit-btn');
            const noteViewCloseBtn = document.getElementById('note-view-close-btn');
            // Modal de borrado
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteModalContent = document.getElementById('delete-modal-content');
            const cancelDeleteButton = document.getElementById('cancel-delete-button');
            const confirmDeleteButton = document.getElementById('confirm-delete-button');
            // NUEVOS elementos para IA
            const aiWriteBtn = document.getElementById('ai-write-btn');
            const aiLoadingOverlay = document.getElementById('ai-loading-overlay');

            const noteColors = [ { bg: 'bg-red-200 dark:bg-red-900/50', text: 'text-red-800 dark:text-red-200' }, { bg: 'bg-yellow-200 dark:bg-yellow-900/50', text: 'text-yellow-800 dark:text-yellow-200' }, { bg: 'bg-green-200 dark:bg-green-900/50', text: 'text-green-800 dark:text-green-200' }, { bg: 'bg-blue-200 dark:bg-blue-900/50', text: 'text-blue-800 dark:text-blue-200' }, { bg: 'bg-indigo-200 dark:bg-indigo-900/50', text: 'text-indigo-800 dark:text-indigo-200' }, { bg: 'bg-purple-200 dark:bg-purple-900/50', text: 'text-purple-800 dark:text-purple-200' }, { bg: 'bg-pink-200 dark:bg-pink-900/50', text: 'text-pink-800 dark:text-pink-200' }, { bg: 'bg-teal-200 dark:bg-teal-900/50', text: 'text-teal-800 dark:text-teal-200' }];
            let notes = JSON.parse(localStorage.getItem('notes-expressive-v3')) || [];
            let noteToDeleteId = null;
            let currentViewingNoteId = null;
            let currentView = localStorage.getItem('notes-view-mode') || 'grid'; // NUEVO

            // --- Lógica del Tema ---
            const applyTheme = (isDark) => document.documentElement.classList.toggle('dark', isDark);
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
            applyTheme(localStorage.getItem('theme') === 'dark');

            // --- NUEVO: Lógica de Vista (Grid/Lista) ---
            const applyView = (view) => {
                if (view === 'list') {
                    notesContainer.classList.remove('grid', 'sm:grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4');
                    notesContainer.classList.add('view-list');
                    viewToggle.querySelector('.material-symbols-outlined').textContent = 'view_list';
                } else { // 'grid'
                    notesContainer.classList.remove('view-list');
                    notesContainer.classList.add('grid', 'sm:grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4');
                    viewToggle.querySelector('.material-symbols-outlined').textContent = 'grid_view';
                }
            };
            viewToggle.addEventListener('click', () => {
                currentView = currentView === 'grid' ? 'list' : 'grid';
                localStorage.setItem('notes-view-mode', currentView);
                applyView(currentView);
            });
            applyView(currentView); // Aplicar vista al cargar

            // --- Lógica de Notas (Guardar y Renderizar) ---
            const saveNotes = () => {
                try {
                    localStorage.setItem('notes-expressive-v3', JSON.stringify(notes));
                } catch (e) {
                    console.error("Error saving notes:", e);
                    // No usamos alert
                }
            };

            const renderNotes = () => {
                notesContainer.innerHTML = '';
                placeholder.classList.toggle('hidden', notes.length > 0);
                notes.forEach(note => {
                    const color = note.colorIndex !== undefined ? noteColors[note.colorIndex % noteColors.length] : noteColors[0];
                    const noteElement = document.createElement('div');
                    noteElement.className = `note-card relative ${color.bg} ${color.text} rounded-2xl p-5 flex flex-col gap-2 transform hover:-translate-y-1 transition-transform duration-200 ease-out fade-in`;
                    noteElement.dataset.id = note.id;

                    let contentHtml = '', iconHtml = '';
                    switch (note.type) {
                        case 'todolist':
                            iconHtml = `<span class="material-symbols-outlined text-lg absolute top-3 right-3 opacity-50">checklist</span>`;
                            contentHtml = '<div class="flex flex-col gap-1 truncate">';
                            note.content.slice(0, 4).forEach(item => {
                                contentHtml += `<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">${item.checked ? 'check_box' : 'check_box_outline_blank'}</span><span class="${item.checked ? 'task-done' : ''}">${item.text}</span></div>`;
                            });
                            if (note.content.length > 4) contentHtml += '...';
                            contentHtml += '</div>';
                            break;
                        case 'doc':
                            iconHtml = `<span class="material-symbols-outlined text-lg absolute top-3 right-3 opacity-50">article</span>`;
                            contentHtml = `<div class="prose dark:prose-invert max-w-none text-sm line-clamp-5">${note.content}</div>`;
                            break;
                        default: // 'note'
                            iconHtml = `<span class="material-symbols-outlined text-lg absolute top-3 right-3 opacity-50">edit_note</span>`;
                            contentHtml = `<p class="text-base break-words flex-grow line-clamp-5">${note.content.replace(/\n/g, '<br>')}</p>`;
                    }
                    const imageHtml = note.imageData ? `<img src="${note.imageData}" class="rounded-lg h-24 w-full object-cover mt-2">` : '';

                    noteElement.innerHTML = `
                        <div class="note-card-body flex-grow flex flex-col gap-2">
                            ${iconHtml}
                            <h3 class="font-bold text-xl break-words pr-8">${note.title}</h3>
                            <div class="flex-grow opacity-90">${contentHtml}</div>
                            ${imageHtml}
                        </div>
                        <div class="flex justify-end gap-1 mt-2">
                            ${note.type === 'doc' ? `<button class="download-btn p-2 rounded-full hover:bg-black/10 transition-colors"><span class="material-symbols-outlined text-lg">download</span></button>` : ''}
                            <button class="edit-btn p-2 rounded-full hover:bg-black/10 transition-colors"><span class="material-symbols-outlined text-lg">edit</span></button>
                            <button class="delete-btn p-2 rounded-full hover:bg-black/10 transition-colors"><span class="material-symbols-outlined text-lg">delete</span></button>
                        </div>`;
                    notesContainer.appendChild(noteElement);
                });
            };

            // --- Lógica de Modales (Abrir/Cerrar) ---
            const openModal = (note = null, type = 'note') => {
                noteForm.reset();
                const noteType = note ? note.type : type;
                noteTypeInput.value = noteType;

                imagePreviewContainer.classList.add('hidden');
                imagePreview.src = '';
                noteImageDataInput.value = '';

                // Ocultar todos los editores y la barra de herramientas
                noteContentTextarea.classList.add('hidden');
                noteContentWysiwyg.classList.add('hidden');
                todolistEditor.classList.add('hidden');
                docToolbar.classList.add('hidden');
                aiWriteBtn.classList.add('hidden'); // Ocultar botón IA por defecto

                if (note) { // Editando
                    noteIdInput.value = note.id;
                    noteTitleInput.value = note.title;
                    if (note.imageData) {
                        imagePreview.src = note.imageData;
                        noteImageDataInput.value = note.imageData;
                        imagePreviewContainer.classList.remove('hidden');
                    }
                } else { // Creando
                    noteIdInput.value = '';
                }

                // Configurar el editor correcto
                if (noteType === 'todolist') {
                    todolistEditor.classList.remove('hidden');
                    buildTodoListEditor(note ? note.content : []);
                } else if (noteType === 'doc') {
                    noteContentWysiwyg.classList.remove('hidden');
                    docToolbar.classList.remove('hidden');
                    aiWriteBtn.classList.remove('hidden'); // Mostrar botón IA
                    noteContentWysiwyg.innerHTML = note ? note.content : '';
                } else { // 'note'
                    noteContentTextarea.classList.remove('hidden');
                    aiWriteBtn.classList.remove('hidden'); // Mostrar botón IA
                    noteContentTextarea.value = note ? note.content : '';
                }

                noteModal.classList.remove('hidden');
                noteModalContent.classList.add('scale-in');
            };

            const closeModal = () => {
                noteModalContent.classList.remove('scale-in');
                noteModalContent.classList.add('scale-out');
                setTimeout(() => {
                    noteModal.classList.add('hidden');
                    noteModalContent.classList.remove('scale-out');
                    aiLoadingOverlay.classList.add('hidden'); // Asegurarse de ocultar el loader
                }, 300);
            };
            
            const openNoteView = (noteId) => {
                const note = notes.find(n => n.id == noteId);
                if (!note) return;
                currentViewingNoteId = noteId;
                noteViewTitle.textContent = note.title;
                noteViewImage.classList.toggle('hidden', !note.imageData);
                if (note.imageData) noteViewImage.src = note.imageData;

                if (note.type === 'todolist') {
                    noteViewBody.innerHTML = note.content.map(item => `<div class="flex items-center gap-3"><span class="material-symbols-outlined">${item.checked ? 'check_box' : 'check_box_outline_blank'}</span><span class="${item.checked ? 'task-done' : ''}">${item.text}</span></div>`).join('');
                } else if (note.type === 'doc') {
                    noteViewBody.innerHTML = note.content;
                } else {
                    noteViewBody.innerHTML = `<p>${note.content.replace(/\n/g, '<br>')}</p>`;
                }
                noteViewModal.classList.remove('hidden', 'fade-out');
                noteViewModal.classList.add('fade-in');
            };
            
            const closeNoteView = () => {
                noteViewModal.classList.remove('fade-in');
                noteViewModal.classList.add('fade-out');
                setTimeout(() => noteViewModal.classList.add('hidden'), 300);
                currentViewingNoteId = null;
            };

            const openDeleteModal = () => {
                deleteConfirmModal.classList.remove('hidden');
                deleteModalContent.classList.add('scale-in');
            };
            const closeDeleteModal = () => {
                deleteModalContent.classList.remove('scale-in');
                deleteModalContent.classList.add('scale-out');
                setTimeout(() => deleteConfirmModal.classList.add('hidden'), 300);
            };

            // --- Constructores de Editores Dinámicos ---
            const buildTodoListEditor = (tasks = []) => {
                todolistEditor.innerHTML = '';
                const taskContainer = document.createElement('div');
                taskContainer.className = "flex flex-col gap-2 overflow-y-auto pr-2";
                const createTaskElement = (task) => {
                    const taskEl = document.createElement('div');
                    taskEl.className = 'task-row flex items-center gap-2';
                    taskEl.innerHTML = `<input type="checkbox" class="task-editor-checkbox h-5 w-5 rounded border-gray-300 text-primary-light focus:ring-primary-light" ${task.checked ? 'checked' : ''}><input type="text" class="task-editor-input flex-grow bg-transparent border-b border-outline-light/50 focus:border-primary-light outline-none py-1" value="${task.text}" placeholder="Nueva tarea"><button type="button" class="remove-task-btn p-1 rounded-full hover:bg-black/10"><span class="material-symbols-outlined text-lg">close</span></button>`;
                    taskEl.querySelector('.remove-task-btn').addEventListener('click', () => taskEl.remove());
                    taskEl.querySelector('.task-editor-input').addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const newTask = createTaskElement({ text: '', checked: false });
                            taskEl.after(newTask);
                            newTask.querySelector('.task-editor-input').focus();
                        }
                    });
                    return taskEl;
                };
                (tasks.length ? tasks : [{ text: '', checked: false }]).forEach(task => taskContainer.appendChild(createTaskElement(task)));
                todolistEditor.appendChild(taskContainer);
                const addTaskBtn = document.createElement('button');
                addTaskBtn.type = 'button';
                addTaskBtn.className = 'flex items-center gap-2 text-primary-light dark:text-primary-dark mt-4 p-2 rounded-lg hover:bg-primary-light/10';
                addTaskBtn.innerHTML = `<span class="material-symbols-outlined">add</span> Añadir tarea`;
                addTaskBtn.addEventListener('click', () => {
                    const newTaskEl = createTaskElement({ text: '', checked: false });
                    taskContainer.appendChild(newTaskEl);
                    newTaskEl.querySelector('.task-editor-input').focus();
                });
                todolistEditor.appendChild(addTaskBtn);
            };

            // --- Event Listeners ---
            addNoteFab.addEventListener('click', (e) => { e.stopPropagation(); fabMenu.classList.toggle('opacity-0'); fabMenu.classList.toggle('translate-y-4'); fabMenu.classList.toggle('pointer-events-none'); fabIcon.classList.toggle('rotate-45'); });
            const closeFabMenu = () => { if (!fabMenu.classList.contains('opacity-0')) { fabMenu.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none'); fabIcon.classList.remove('rotate-45'); } };
            document.addEventListener('click', closeFabMenu);
            fabMenu.addEventListener('click', (e) => { const btn = e.target.closest('.fab-option'); if (btn) { openModal(null, btn.dataset.type); closeFabMenu(); } });

            cancelButton.addEventListener('click', closeModal);
            noteModal.addEventListener('click', (e) => { if (e.target === noteModal) closeModal(); });

            noteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = noteIdInput.value;
                const title = noteTitleInput.value.trim() || 'Sin título';
                const type = noteTypeInput.value;
                const imageData = noteImageDataInput.value;
                let content;
                if (type === 'todolist') {
                    content = Array.from(todolistEditor.querySelectorAll('.task-row')).map(el => ({ text: el.querySelector('.task-editor-input').value.trim(), checked: el.querySelector('.task-editor-checkbox').checked })).filter(t => t.text);
                } else if (type === 'doc') {
                    content = noteContentWysiwyg.innerHTML;
                } else {
                    content = noteContentTextarea.value.trim();
                }

                if (id) {
                    const noteIndex = notes.findIndex(n => n.id == id);
                    if (noteIndex !== -1) Object.assign(notes[noteIndex], { title, content, imageData });
                } else {
                    notes.unshift({ id: Date.now(), title, type, content, imageData, colorIndex: Math.floor(Math.random() * noteColors.length) });
                }
                saveNotes();
                renderNotes();
                closeModal();
            });

            notesContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                const noteCard = e.target.closest('.note-card');
                if (!noteCard) return;
                const noteId = noteCard.dataset.id;
                const note = notes.find(n => n.id == noteId);
                if (!note) return;
                if (button) {
                    e.stopPropagation();
                    if (button.classList.contains('edit-btn')) openModal(note);
                    else if (button.classList.contains('delete-btn')) { noteToDeleteId = noteId; openDeleteModal(); }
                    else if (button.classList.contains('download-btn')) downloadNote(note);
                } else if (e.target.closest('.note-card-body')) {
                    openNoteView(noteId);
                }
            });

            noteViewCloseBtn.addEventListener('click', closeNoteView);
            noteViewEditBtn.addEventListener('click', () => { if (currentViewingNoteId) { const note = notes.find(n => n.id == currentViewingNoteId); if(note) { closeNoteView(); openModal(note); } } });
            cancelDeleteButton.addEventListener('click', closeDeleteModal);
            confirmDeleteButton.addEventListener('click', () => { if (noteToDeleteId) { notes = notes.filter(n => n.id != noteToDeleteId); saveNotes(); renderNotes(); closeDeleteModal(); noteToDeleteId = null; } });

            addImageBtn.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => { noteImageDataInput.value = event.target.result; imagePreview.src = event.target.result; imagePreviewContainer.classList.remove('hidden'); };
                reader.readAsDataURL(file);
            });
            removeImageBtn.addEventListener('click', () => { imageInput.value = ''; noteImageDataInput.value = ''; imagePreview.src = ''; imagePreviewContainer.classList.add('hidden'); });
            
            docToolbar.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-command]');
                if (button) document.execCommand(button.dataset.command, false, null);
            });
            docToolbar.addEventListener('change', (e) => {
                const select = e.target.closest('select');
                if (select) document.execCommand(select.id === 'font-name-select' ? 'fontName' : 'fontSize', false, select.value);
            });
            
            const downloadNote = (note) => {
                let contentString = `Título: ${note.title}\n\n`;
                if (note.type === 'todolist') contentString += note.content.map(task => `[${task.checked ? 'x' : ' '}] ${task.text}`).join('\n');
                else if (note.type === 'doc') {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = note.content;
                    contentString += tempDiv.innerText;
                }
                else contentString += note.content;
                const blob = new Blob([contentString], { type: 'text/plain;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${note.title.replace(/[^a-z0-9]/gi, '_')}.txt`;
                a.click();
                URL.revokeObjectURL(a.href);
            };

            // --- NUEVO: Lógica de Escritura con IA ---
            aiWriteBtn.addEventListener('click', async () => {
                const title = noteTitleInput.value.trim();
                if (!title) {
                    noteTitleInput.focus();
                    noteTitleInput.placeholder = "Escribe un título primero para la IA";
                    return;
                }

                const noteType = noteTypeInput.value;
                const currentContent = noteType === 'doc' ? noteContentWysiwyg.innerText : noteContentTextarea.value;
                const prompt = `Basado en el título "${title}" y el contenido existente, continúa escribiendo la nota de forma coherente y útil. Contenido actual: "${currentContent}"`;

                aiLoadingOverlay.classList.remove('hidden');

                try {
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Error de la API: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        
                        const generatedText = result.candidates[0].content.parts[0].text;
                        
                        if (noteType === 'doc') {
                            // Para el editor WYSIWYG, insertamos el texto como HTML para mantener los saltos de línea
                            noteContentWysiwyg.innerHTML += generatedText.replace(/\n/g, '<br>');
                        } else {
                            noteContentTextarea.value += '\n' + generatedText;
                        }
                    } else {
                        console.error("Respuesta inesperada de la API:", result);
                    }

                } catch (error) {
                    console.error("Error al generar texto con IA:", error);
                    // Podríamos mostrar un mensaje de error al usuario aquí
                } finally {
                    aiLoadingOverlay.classList.add('hidden');
                }
            });

            renderNotes();
        });
    </script>
</body>
</html>
